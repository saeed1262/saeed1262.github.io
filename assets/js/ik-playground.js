(()=>{"use strict";function e(){let e=Q.x,t=Q.y,a=0;ee[0].x=e,ee[0].y=t;for(let l=0;l<Z;l++)a+=_[l],te[l]=a,e+=Math.cos(a)*$,t+=Math.sin(a)*$,ee[l+1].x=e,ee[l+1].y=t}function t(){if(!w||!w.checked)return!1;const t=(parseFloat(M.value||M)||160)*Math.PI/180;let a=!1;for(let e=0;e<Z;e++){const l=_[e];_[e]=se(_[e],-t,t),_[e]!==l&&(a=!0)}return a&&e(),a}function a(a){const l=parseInt(p.value,10);for(let n=0;n<l;n++){for(let l=Z-1;l>=0;l--){const n=ee[l].x,o=ee[l].y,i=ee[Z].x-n,r=ee[Z].y-o,s=V.x-n,c=V.y-o,h=Math.atan2(r,i);let d=Math.atan2(c,s)-h;d=Math.atan2(Math.sin(d),Math.cos(d)),_[l]+=d*a,e(),t()}const l=parseFloat(C?C.value:"0");if(l>0){for(let e=0;e<Z;e++)_[e]+=(le[e]-_[e])*l;e(),t()}}return l}function l(){const a=parseInt(p.value,10),l=parseFloat(b.value),n=ee.map(e=>({x:e.x,y:e.y})),o={x:n[0].x,y:n[0].y},i=Z*$,r=ce(o.x,o.y,V.x,V.y);for(let e=0;e<a;e++)if(r>i+1e-6)for(let e=0;e<Z;e++){const t=V.x-n[e].x,a=V.y-n[e].y,l=Math.hypot(t,a)||1;n[e+1].x=n[e].x+t/l*$,n[e+1].y=n[e].y+a/l*$}else{n[Z].x=V.x,n[Z].y=V.y;for(let e=Z-1;e>=0;e--){const t=n[e].x-n[e+1].x,a=n[e].y-n[e+1].y,l=Math.hypot(t,a)||1,o=$/l;n[e].x=n[e+1].x+t*o,n[e].y=n[e+1].y+a*o}n[0].x=o.x,n[0].y=o.y;for(let e=0;e<Z;e++){const t=n[e+1].x-n[e].x,a=n[e+1].y-n[e].y,l=Math.hypot(t,a)||1,o=$/l;n[e+1].x=n[e].x+t*o,n[e+1].y=n[e].y+a*o}}for(let e=0;e<=Z;e++)ee[e].x=he(ee[e].x,n[e].x,l),ee[e].y=he(ee[e].y,n[e].y,l);for(let e=0;e<Z;e++){const t=ee[e].x,a=ee[e].y,l=ee[e+1].x-t,n=ee[e+1].y-a,o=Math.atan2(n,l);if(0===e)_[0]=o;else{let t=0;for(let a=0;a<e;a++)t+=_[a];_[e]=o-t}}t();const s=parseFloat(C?C.value:"0");if(s>0){for(let e=0;e<Z;e++)_[e]+=(le[e]-_[e])*s;e(),t()}return a}function n(){const a=parseInt(p.value,10),l=parseFloat(k.value),n=parseFloat(b.value),o=1e-8;for(let i=0;i<a;i++){const a=ee[Z].x,i=ee[Z].y,r=V.x-a,s=V.y-i;if(r*r+s*s<.25)break;const c=new Float64Array(Z);let h=0,d=0;for(let e=0;e<Z;e++){const t=ee[e].x,l=-(i-ee[e].y),n=a-t,o=l*r+n*s;c[e]=o,h+=l*o,d+=n*o}let y=(r*h+s*d)/(h*h+d*d+o);y=se(y,0,l);for(let e=0;e<Z;e++)_[e]+=y*c[e]*n;t();const x=parseFloat(C?C.value:"0");if(x>0)for(let e=0;e<Z;e++)_[e]+=(le[e]-_[e])*x;e()}return a}function o(){const a=parseInt(p.value,10),l=parseFloat(m.value),n=parseFloat(b.value),o=l*l,i=1e-9;for(let l=0;l<a;l++){const a=ee[Z].x,l=ee[Z].y,r=V.x-a,s=V.y-l;if(r*r+s*s<.25)break;let c=o,h=0,d=o;const y=new Array(Z);for(let e=0;e<Z;e++){const t=-(l-ee[e].y),n=a-ee[e].x;y[e]=[t,n],c+=t*t,h+=t*n,d+=n*n}const x=c*d-h*h,f=x?-h/(x+i):0,u=(x?d/(x+i):0)*r+f*s,v=f*r+(x?c/(x+i):0)*s;for(let e=0;e<Z;e++){const t=y[e],a=t[0]*u+t[1]*v;_[e]+=a*n}t();const g=parseFloat(C?C.value:"0");if(g>0)for(let e=0;e<Z;e++)_[e]+=(le[e]-_[e])*g;e()}return a}function i(){Z=parseInt(v.value,10),$=parseFloat(g.value),_=new Float64Array(Z).fill(0),te=new Float64Array(Z).fill(0),le=new Float64Array(Z).fill(0),ee=new Array(Z+1).fill(0).map(()=>({x:0,y:0})),e()}function r(){Y.linksLabel.textContent=v.value,Y.lenLabel.textContent=g.value,Y.itersLabel.textContent=p.value,Y.gammaLabel&&k&&(Y.gammaLabel.textContent=k.value),Y.lambdaLabel&&m&&(Y.lambdaLabel.textContent=m.value),I&&M&&(I.textContent=M.value),S&&C&&(S.textContent=parseFloat(C.value).toFixed(2)),W&&H&&(W.textContent=parseFloat(H.value).toFixed(1)),Y.dampLabel.textContent=b.value,U.textContent=u.options[u.selectedIndex].text}function s(){if(!x)return;y.clearRect(0,0,h.width,h.height),y.save(),y.globalAlpha=.15,y.strokeStyle="#0ea5a5",y.lineWidth=1;const e=40;for(let t=0;t<h.width;t+=e)y.beginPath(),y.moveTo(t,0),y.lineTo(t,h.height),y.stroke();for(let t=0;t<h.height;t+=e)y.beginPath(),y.moveTo(0,t),y.lineTo(h.width,t),y.stroke();y.restore(),E.checked&&(y.save(),y.strokeStyle="rgba(52, 211, 153, 0.35)",y.lineWidth=2,y.beginPath(),y.arc(Q.x,Q.y,Z*$,0,2*Math.PI),y.stroke(),y.restore()),y.save();const t=ce(Q.x,Q.y,V.x,V.y)<=Z*$+1e-6;if(y.fillStyle=t?"#f59e0b":"#ef4444",y.beginPath(),y.arc(V.x,V.y,8,0,2*Math.PI),y.fill(),y.strokeStyle=t?"rgba(245,158,11,0.4)":"rgba(239,68,68,0.45)",y.beginPath(),y.moveTo(V.x-12,V.y),y.lineTo(V.x+12,V.y),y.stroke(),y.beginPath(),y.moveTo(V.x,V.y-12),y.lineTo(V.x,V.y+12),y.stroke(),y.restore(),F.checked&&ae.length>1){y.save(),y.strokeStyle="rgba(59,130,246,0.45)",y.lineWidth=2,y.beginPath(),y.moveTo(ae[0].x,ae[0].y);for(let e=1;e<ae.length;e++)y.lineTo(ae[e].x,ae[e].y);y.stroke(),y.restore()}y.save();for(let e=0;e<Z;e++)if(y.lineCap="round",y.lineWidth=10,y.strokeStyle=e===Z-1?"#60a5fa":"#34d399",y.beginPath(),y.moveTo(ee[e].x,ee[e].y),y.lineTo(ee[e+1].x,ee[e+1].y),y.stroke(),y.fillStyle="#0ea5a5",y.beginPath(),y.arc(ee[e].x,ee[e].y,6,0,2*Math.PI),y.fill(),P&&P.checked&&w&&w.checked){const t=parseFloat(M.value||"160")*Math.PI/180,a=0===e?0:te[e-1],l=a-t,n=a+t;y.strokeStyle="rgba(16,185,129,0.55)",y.lineWidth=3,y.beginPath(),y.arc(ee[e].x,ee[e].y,18,l,n),y.stroke()}if(y.fillStyle="#3b82f6",y.beginPath(),y.arc(ee[Z].x,ee[Z].y,6,0,2*Math.PI),y.fill(),y.restore(),D&&D.checked){const e=240,t=80,a=8,l=h.width-e-12,n=12;y.save(),y.globalAlpha=.9,y.fillStyle="rgba(2,6,23,0.75)",y.strokeStyle="rgba(16,185,129,0.35)",y.lineWidth=1,y.beginPath(),y.roundRect?y.roundRect(l,n,e,t,8):y.rect(l,n,e,t),y.fill(),y.stroke();const o=Math.max(10,...ie);y.strokeStyle="#34d399",y.beginPath(),ie.forEach((i,r)=>{const s=l+a+r/Math.max(1,re-1)*(e-2*a),c=n+t-a-i/o*(t-2*a);0===r?y.moveTo(s,c):y.lineTo(s,c)}),y.stroke(),y.fillStyle="rgba(255,255,255,0.7)",y.font="12px ui-monospace, SF Mono, monospace",y.fillText("Error",l+10,n+16),y.restore()}}function c(e){const t=(e-xe)/1e3;xe=e,fe=he(fe,1/Math.max(.001,t),.1);const i=H?parseFloat(H.value):1;if(oe+=t*i,"circle"===ne){const e=Z*$*.65;V.x=Q.x+e*Math.cos(1.2*oe),V.y=Q.y+e*Math.sin(1.2*oe)}else if("eight"===ne){const e=Z*$*.55;V.x=Q.x+e*Math.sin(1.2*oe),V.y=Q.y+e*Math.sin(2.4*oe)*.6}if(!L.checked){let e=0;e="ccd"===u.value?a(parseFloat(b.value)):"fabrik"===u.value?l():"jt"===u.value?n():o(),G.textContent=e.toString()}const r=ce(ee[Z].x,ee[Z].y,V.x,V.y);z.textContent=r.toFixed(2)+" px",X.textContent=Math.round(fe).toString(),ie.push(r),ie.length>re&&ie.shift(),F.checked?(ae.push({x:ee[Z].x,y:ee[Z].y}),ae.length>1e3&&ae.shift()):ae.length=0,s(),requestAnimationFrame(c)}const h=document.getElementById("ik-canvas"),d=document.getElementById("ik-loading"),y=h?h.getContext("2d"):null,x=!!y,f=e=>document.getElementById(e),u=f("ikAlgo"),v=f("links"),g=f("len"),p=f("iters"),k=f("gamma"),m=f("lambda"),b=f("damp"),L=f("pauseIK"),E=f("showGhost"),F=f("showTrace"),w=f("limitsEnabled"),M=f("limitDeg"),I=f("limitDegLabel"),P=f("showLimits"),C=f("restBias"),S=f("restLabel"),A=f("setRest"),N=f("resetRest"),T=f("moveNone"),R=f("moveCircle"),B=f("moveEight"),H=f("targetSpeed"),W=f("speed2Label"),j=f("toggleHelp"),D=f("showMetrics"),q=f("ik-help"),K=f("closeHelp"),U=f("hudAlgo"),z=f("hudErr"),G=f("hudIters"),X=f("hudFps"),Y={linksLabel:f("linksLabel"),lenLabel:f("lenLabel"),itersLabel:f("itersLabel"),gammaLabel:f("gammaLabel"),lambdaLabel:f("lambdaLabel"),dampLabel:f("dampLabel")},J=document.getElementById("jt-only"),O=document.getElementById("dls-only");let Q={x:h?.5*h.width:600,y:h?.5*h.height:350},V={x:h?.75*h.width:900,y:h?.45*h.height:315},Z=parseInt(v.value,10),$=parseFloat(g.value),_=new Float64Array(Z).fill(0),ee=new Array(Z+1).fill(0).map(()=>({x:0,y:0})),te=new Float64Array(Z).fill(0),ae=[],le=new Float64Array(Z).fill(0),ne="none",oe=0;const ie=[],re=360,se=(e,t,a)=>Math.max(t,Math.min(a,e)),ce=(e,t,a,l)=>Math.hypot(a-e,l-t),he=(e,t,a)=>e+(t-e)*a;[v,g].filter(Boolean).forEach(e=>e.addEventListener("input",()=>{i(),r()})),[p,k,m,b,u].filter(Boolean).forEach(e=>e.addEventListener("input",r)),u.addEventListener("change",()=>{J.style.display="jt"===u.value?"flex":"none",O.style.display="dls"===u.value?"flex":"none"}),A&&A.addEventListener("click",()=>{for(let e=0;e<Z;e++)le[e]=_[e]}),N&&N.addEventListener("click",()=>{le=new Float64Array(Z).fill(0)}),T&&T.addEventListener("click",()=>ne="none"),R&&R.addEventListener("click",()=>ne="circle"),B&&B.addEventListener("click",()=>ne="eight"),j&&j.addEventListener("click",()=>{q&&(q.hidden=!1)}),K&&K.addEventListener("click",()=>{q&&(q.hidden=!0)}),q&&q.addEventListener("click",e=>{(e.target===q||e.target.classList.contains("ik-help-backdrop"))&&(q.hidden=!0)}),document.addEventListener("click",e=>{if(!e.target||!e.target.closest)return;const t=["setRest","resetRest","moveNone","moveCircle","moveEight","toggleHelp","closeHelp"];let a=null;for(const l of t)if(e.target.closest("#"+l)){a=l;break}if(a)if(e.preventDefault(),"setRest"===a){for(let e=0;e<Z;e++)le[e]=_[e];r()}else"resetRest"===a?(le=new Float64Array(Z).fill(0),r()):"moveNone"===a?ne="none":"moveCircle"===a?ne="circle":"moveEight"===a?ne="eight":"toggleHelp"===a?q&&(q.hidden=!1):"closeHelp"===a&&q&&(q.hidden=!0)});let de=null;const ye=e=>{const t=h.getBoundingClientRect();return{x:(e.clientX-t.left)*(h.width/t.width),y:(e.clientY-t.top)*(h.height/t.height)}};h&&h.addEventListener("pointerdown",e=>{const t=ye(e),a=ce(t.x,t.y,Q.x,Q.y);ce(t.x,t.y,V.x,V.y);de=e.shiftKey||a<20?"base":"target","base"===de?(Q.x=t.x,Q.y=t.y):(V.x=t.x,V.y=t.y)}),window.addEventListener("pointermove",e=>{if(!de)return;const t=ye(e);"base"===de?(Q.x=t.x,Q.y=t.y):(V.x=t.x,V.y=t.y)}),window.addEventListener("pointerup",()=>de=null);let xe=performance.now(),fe=0;r(),J&&(J.style.display="jt"===u.value?"flex":"none"),O&&(O.style.display="dls"===u.value?"flex":"none"),e(),d&&(d.style.display="none"),requestAnimationFrame(c),window.addEventListener("keydown",e=>{(!e.target||"INPUT"!==e.target.tagName&&"SELECT"!==e.target.tagName)&&("p"===e.key?L.checked=!L.checked:"t"===e.key?F.checked=!F.checked:"g"===e.key?E.checked=!E.checked:"k"===e.key?D&&(D.checked=!D.checked):"?"===e.key?q&&(q.hidden=!q.hidden):"Escape"===e.key?q&&!q.hidden&&(q.hidden=!0):"c"===e.key?ne="circle":"l"===e.key?ne="eight":"s"===e.key?ne="none":"1"===e.key?(u.value="ccd",u.dispatchEvent(new Event("change"))):"2"===e.key?(u.value="fabrik",u.dispatchEvent(new Event("change"))):"3"===e.key?(u.value="jt",u.dispatchEvent(new Event("change"))):"4"===e.key&&(u.value="dls",u.dispatchEvent(new Event("change"))))});try{const e=new URLSearchParams(location.search),t=(t,a)=>e.has(t)?e.get(t):a,a=(t,a)=>{t&&e.has(a)&&(t.value=e.get(a))};if(e.size){const e=t("algo",null);e&&(u.value=e),a(v,"n"),a(g,"L"),a(p,"it"),a(k,"g"),a(m,"la"),a(b,"d"),L&&(L.checked="1"===t("px","0")),E&&(E.checked="1"===t("rg","1")),F&&(F.checked="1"===t("tr","0")),w&&(w.checked="1"===t("lm","0")),a(M,"ld"),P&&(P.checked="1"===t("sl","0")),a(C,"rb");const l=parseFloat(t("mx",NaN)),n=parseFloat(t("my",NaN)),o=parseFloat(t("tx",NaN)),s=parseFloat(t("ty",NaN));Number.isFinite(l)&&Number.isFinite(n)&&(Q.x=l,Q.y=n),Number.isFinite(o)&&Number.isFinite(s)&&(V.x=o,V.y=s);const c=t("mv","none");["none","circle","eight"].includes(c)&&(ne=c),a(H,"sp"),i(),r(),u.dispatchEvent(new Event("change"))}}catch{}})();