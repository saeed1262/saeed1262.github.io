import*as THREE from"three";import{OrbitControls}from"three/addons/controls/OrbitControls.js";export function initOrbitSimulator(e=document){function t(e,t,n=1e-8){let o=e;for(let a=0;a<10;a++){const a=(o-t*Math.sin(o)-e)/(1-t*Math.cos(o));if(o-=a,Math.abs(a)<n)break}return o}function n(e){const[t,n,o,a]=e,i=t*(1-n*n)/(1+n*Math.cos(a)),s=Math.cos(o+a),r=Math.sin(o+a),c=new THREE.Vector3(i*s,i*r,0),d=Math.sqrt(L*t*(1-n*n)),l=-L/d*Math.sin(o+a),u=L/d*(n+Math.cos(o+a)),m=new THREE.Vector3(l,u,0);return{position:c,velocity:m,r:i,speed:m.length()}}function o(e,t){const n=e.length(),o=t.length(),a=(new THREE.Vector3).crossVectors(e,t),i=a.length(),s=(new THREE.Vector3).crossVectors(t,a).divideScalar(L).sub(e.clone().normalize());let r=s.length();const c=-L/(2*(.5*o*o-L/n));let d,l;if(r<1e-6)d=0,l=Math.atan2(e.y,e.x);else{d=Math.atan2(s.y,s.x);const t=s.dot(e)/(r*n),o=a.dot((new THREE.Vector3).crossVectors(s,e))/(i*r*n);l=Math.atan2(o,t)}for(;l<0;)l+=2*Math.PI;for(;l>2*Math.PI;)l-=2*Math.PI;return r<1e-6&&(r=0),[c,r,d,l]}function a(e,n){const[o,a,i,s]=e,r=(a+Math.cos(s))/(1+a*Math.cos(s)),c=Math.sqrt(1-a*a)*Math.sin(s)/(1+a*Math.cos(s)),d=Math.atan2(c,r),l=t(d-a*Math.sin(d)+Math.sqrt(L/(o*o*o))*n,a),u=(Math.cos(l)-a)/(1-a*Math.cos(l)),m=Math.sqrt(1-a*a)*Math.sin(l)/(1-a*Math.cos(l));return[o,a,i,Math.atan2(m,u)]}function i(e,t){const a=n(e),i=a.velocity.clone().add(t);return o(a.position,i)}function s(e,t){let n=t[3]-e[3];for(;n<0;)n+=2*Math.PI;for(;n>2*Math.PI;)n-=2*Math.PI;return n}function r(e,t,o=null){if(null===o){const[t]=e;o=1.5*(2*Math.PI*Math.sqrt(t*t*t/L))}let i=1/0,s=0,r=null,c=null;const d=.01,l=Math.floor(o/d);let u=[...e],m=[...t];for(let e=0;e<l;e++){const t=n(u),o=n(m),l=t.position.distanceTo(o.position);l<i&&(i=l,s=e*d,r={...t},c={...o}),u=a(u,d),m=a(m,d)}return{minRange:i,timeToCA:s,chaserStateAtCA:r,targetStateAtCA:c}}function c(e=500){const t=new Float32Array(3*e),n=new THREE.BufferGeometry;return n.setAttribute("position",new THREE.BufferAttribute(t,3)),n.setDrawRange(0,0),n}function d(e,t,n=500){const o=e.attributes.position.array,a=e.drawRange.count;if(a<n){const n=3*a;o[n]=t.x,o[n+1]=t.y,o[n+2]=t.z,e.setDrawRange(0,a+1)}else{for(let e=0;e<3*(n-1);e++)o[e]=o[e+3];const e=3*(n-1);o[e]=t.x,o[e+1]=t.y,o[e+2]=t.z}e.attributes.position.needsUpdate=!0}function l(){const e=n(me),t=n(pe),[o,a]=me,i=2*Math.PI*Math.sqrt(o*o*o/L),[c,d]=pe,l=2*Math.PI*Math.sqrt(c*c*c/L);ce.realWorldUnits?(document.getElementById("chaser-a").textContent=`${(o*A).toFixed(0)} km`,document.getElementById("chaser-period").textContent=`${(i*D/60).toFixed(1)} min`,document.getElementById("chaser-speed").textContent=`${(e.speed*z).toFixed(2)} km/s`,document.getElementById("target-a").textContent=`${(c*A).toFixed(0)} km`,document.getElementById("target-period").textContent=`${(l*D/60).toFixed(1)} min`):(document.getElementById("chaser-a").textContent=`${o.toFixed(3)} R\u2295`,document.getElementById("chaser-period").textContent=`${i.toFixed(2)} TU`,document.getElementById("chaser-speed").textContent=`${e.speed.toFixed(3)} VU`,document.getElementById("target-a").textContent=`${c.toFixed(3)} R\u2295`,document.getElementById("target-period").textContent=`${l.toFixed(2)} TU`),document.getElementById("chaser-e").textContent=a.toFixed(3),document.getElementById("target-e").textContent=d.toFixed(3);const u=s(me,pe);document.getElementById("phase-angle").textContent=`${(180*u/Math.PI).toFixed(1)}\xb0`;const m=e.position.distanceTo(t.position),p=-(new THREE.Vector3).subVectors(e.velocity,t.velocity).dot((new THREE.Vector3).subVectors(t.position,e.position).normalize());ce.realWorldUnits?(document.getElementById("relative-range").textContent=`${(m*A).toFixed(1)} km`,document.getElementById("closing-rate").textContent=`${(p*z).toFixed(3)} km/s`,document.getElementById("dv-budget").textContent=`${(le*z).toFixed(2)} km/s`):(document.getElementById("relative-range").textContent=`${m.toFixed(3)} R\u2295`,document.getElementById("closing-rate").textContent=`${p.toFixed(3)} VU`,document.getElementById("dv-budget").textContent=`${le.toFixed(3)} VU`),(!he.result||de-he.lastAt>=he.interval)&&(he.result=r(me,pe),he.lastAt=de);const h=he.result;ce.realWorldUnits?(document.getElementById("time-to-ca").textContent=h.timeToCA>0?`${(h.timeToCA*D/60).toFixed(1)} min`:"-- min",document.getElementById("min-range").textContent=`${(h.minRange*A).toFixed(1)} km`):(document.getElementById("time-to-ca").textContent=h.timeToCA>0?`${h.timeToCA.toFixed(1)} TU`:"-- TU",document.getElementById("min-range").textContent=`${h.minRange.toFixed(3)} R\u2295`);const g=ce.playing?"Running":"Paused";document.getElementById("orbit-status").textContent=ce.realWorldUnits?`${g} | Time: ${(de*D/60).toFixed(1)} min | Range: ${(m*A).toFixed(1)} km`:`${g} | Time: ${de.toFixed(1)} TU | Range: ${m.toFixed(3)} R\u2295`}function u(e,t,n,o){const a=e*(1-t*t)/(1+t*Math.cos(o)),i=n+o;return new THREE.Vector3(a*Math.cos(i),a*Math.sin(i),0)}function m(e=2278750,t=.08){const n=new THREE.Group,o=new THREE.Mesh(new THREE.CylinderGeometry(.008,.008,t,8),new THREE.MeshPhongMaterial({color:e,emissive:e,emissiveIntensity:.3}));o.rotation.z=Math.PI/2,n.add(o);const a=new THREE.Mesh(new THREE.ConeGeometry(.02,.04,8),new THREE.MeshPhongMaterial({color:e,emissive:e,emissiveIntensity:.3}));return a.position.x=t/2+.02,a.rotation.z=-Math.PI/2,n.add(a),n}function p(){if(!se||!re)return;const e="hohmann"===ue;if(se.visible=e,re.visible=e,e){const[e,t,n]=me,o=u(e,t,n,0),a=u(e,t,n,Math.PI);se.position.copy(o),re.position.copy(a);const i=Math.atan2(o.y,o.x)+Math.PI/2,s=Math.atan2(a.y,a.x)+Math.PI/2;se.rotation.z=i,re.rotation.z=s;const r=V?1:.8+.2*Math.sin(4*de);se.scale.setScalar(r),re.scale.setScalar(r)}}function h(e,t){return new THREE.Mesh(new THREE.SphereGeometry(t,16,16),new THREE.MeshBasicMaterial({color:e,transparent:!0,opacity:.3,side:THREE.BackSide}))}function g(e=58879,t=.035){const n=new THREE.Mesh(new THREE.SphereGeometry(t,16,16),new THREE.MeshPhongMaterial({color:e,emissive:0,shininess:80,specular:4473924}));return n.castShadow=!0,n}function E(e,t="#e5e7eb",n=48){const o=document.createElement("canvas"),a=o.getContext("2d"),i=16;a.font=`bold ${n}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto`;const s=Math.ceil(a.measureText(e).width)+2*i,r=n+2*i;o.width=s,o.height=r;const c=a.createLinearGradient(0,0,s,r);c.addColorStop(0,"rgba(30,41,59,0.8)"),c.addColorStop(1,"rgba(15,23,42,0.8)"),a.fillStyle=c,a.fillRect(0,0,s,r),a.strokeStyle="rgba(59,130,246,0.6)",a.lineWidth=2,a.strokeRect(1,1,s-2,r-2),a.font=`bold ${n}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto`,a.fillStyle=t,a.textBaseline="middle",a.textAlign="center",a.fillText(e,s/2,r/2);const d=new THREE.CanvasTexture(o);d.anisotropy=4,d.needsUpdate=!0;const l=new THREE.Sprite(new THREE.SpriteMaterial({map:d,transparent:!0})),u=.45;return l.scale.set(o.width/200*u,o.height/200*u,1),l.userData.canvasTexture=d,l.renderOrder=999,l}function y(){if(!(ne&&oe&&ae&&ie))return;const[e,t,n]=me,o=u(e,t,n,0),a=u(e,t,n,Math.PI);ne.position.copy(o),oe.position.copy(a),ae.position.copy(o.clone().multiplyScalar(1.06)),ie.position.copy(a.clone().multiplyScalar(1.06))}function b(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function M(e,t){if(e<=0||t<=0)return null;const n=Math.PI*Math.sqrt(Math.pow((e+t)/2,3)),o=Math.sqrt(1/Math.pow(t,3));return b(Math.PI-o*n)}function f(){const[e]=me,[t]=pe,n=M(e,t),o=s(me,pe),a=null==n?"\u2014":`${(180*n/Math.PI).toFixed(1)}\xb0`,i=null==n?"\u2014":`${(180*b(n-o)/Math.PI).toFixed(1)}\xb0`;document.getElementById("phase-current").textContent=`${(180*o/Math.PI).toFixed(1)}\xb0`,document.getElementById("phase-desired").textContent=a,document.getElementById("phase-error").textContent=i;const r=document.getElementById("phase-fill");let c=document.getElementById("phase-status");if(null==n)return r.style.width="0%",c.textContent="N/A",c.className="phase-status na",!1;const d=Math.abs(b(n-o)),l=Math.max(0,100-180*d/Math.PI);return r.style.width=`${l}%`,d<5*Math.PI/180?(c.textContent="Ready",c.className="phase-status good"):d<20*Math.PI/180?(c.textContent="Close",c.className="phase-status warn"):(c.textContent="Poor",c.className="phase-status bad"),d<5*Math.PI/180}function w(e){const t=document.querySelector(".orbit-toast");t&&t.remove();const n=document.createElement("div");n.className="orbit-toast",n.innerHTML=`<span class="toast-icon">\ud83d\udca1</span>${e}`,document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),50),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),400)},4e3)}function v(e,t,n){const[o,a]=n,i=t.r,s=o*(1-a),r=o*(1+a),c=Math.abs(i-s)<.1*o,d=Math.abs(i-r)<.1*o;let l="";"prograde"===e?l=c?"\ud83d\ude80 Apoapsis \u2191, current speed \u2191 (instant), average speed \u2193 after apoapsis":d?"\ud83c\udf0d Periapsis \u2191, current speed \u2191 (instant), higher orbit is slower overall":"\u2b06\ufe0f Prograde raises opposite side \u2014 energy increases, effects are delayed":"retrograde"===e?l=c?"\u2b07\ufe0f Apoapsis \u2193, current speed \u2193 (instant), lower orbit is faster overall":d?"\ud83c\udfaf Periapsis \u2193, dropping to a lower, faster orbit \u2014 great for catching up":"\ud83d\udd3b Retrograde lowers opposite side \u2014 less energy, faster average speed":"radial-out"===e?l="\ud83d\udce1 +R: raise periapsis while lowering apoapsis \u2014 circularizing from below":"radial-in"===e&&(l="\ud83c\udfaf -R: lower periapsis while raising apoapsis \u2014 circularizing from above"),l&&w(l)}function x(){if(me=[1.3,0,0,0],pe=[1.3,0,0,Math.PI/6],de=0,le=0,he.result=null,ue=null,J&&J.setDrawRange(0,0),Q&&Q.setDrawRange(0,0),Y&&Y.setDrawRange(0,0),N&&j){const e=n(me),t=n(pe);N.position.copy(e.position),j.position.copy(t.position)}l(),y(),f(),p()}function R(e){switch(e){case"basic":me=[1.3,0,0,-Math.PI/3],pe=[1.3,0,0,0],ue="basic",document.getElementById("orbit-status").textContent="Basic Phasing: Try a -V burn to lower orbit and catch up";break;case"hohmann":me=[1.2,0,0,0],pe=[1.4,0,0,Math.PI],ue="hohmann",document.getElementById("orbit-status").textContent="Hohmann: +V at periapsis, then +V at apoapsis to circularize";break;case"rendezvous":me=[1.295,.02,0,Math.PI+Math.PI/12],pe=[1.3,0,0,0],ue="rendezvous",document.getElementById("orbit-status").textContent="R-bar Approach: Use small -R burns for radial corridor approach";break;default:return}if(J&&J.setDrawRange(0,0),Q&&Q.setDrawRange(0,0),Y&&Y.setDrawRange(0,0),de=0,le=0,he.result=null,N&&j){const e=n(me),t=n(pe);N.position.copy(e.position),j.position.copy(t.position)}l(),y(),f(),p()}function I(e){const[t,n]=e;return t*(1-n)}function T(e){const t=n(me),o=t.position.clone().normalize(),s=t.velocity.clone().normalize();let r=new THREE.Vector3;switch(e){case"prograde":r.copy(s).multiplyScalar(ce.burnMagnitude);break;case"retrograde":r.copy(s).multiplyScalar(-ce.burnMagnitude);break;case"radial-out":r.copy(o).multiplyScalar(ce.burnMagnitude);break;case"radial-in":r.copy(o).multiplyScalar(-ce.burnMagnitude)}const c=1.02*$;let d=r.clone(),u=i(me,d);if(I(u)<c){let e=0,t=1,n=0;for(let o=0;o<16;o++){const o=.5*(e+t),a=r.clone().multiplyScalar(o);I(i(me,a))>=c?(n=o,e=o):t=o}d=r.clone().multiplyScalar(n),u=i(me,d),w(`\u26a0\ufe0f Burn reduced to avoid surface intercept (rp \u2265 ${c.toFixed(2)} R\u2295)`)}if(me=u,le+=d.length(),Y){const e=Y.attributes.position.array;let t=[...me];for(let o=0;o<200;o++){const i=n(t);e[3*o]=i.position.x,e[3*o+1]=i.position.y,e[3*o+2]=i.position.z,t=a(t,.02)}Y.setDrawRange(0,200),Y.attributes.position.needsUpdate=!0,K&&K.computeLineDistances&&K.computeLineDistances()}v(e,t,me),l(),y(),f()}function C(){const e=document.getElementById("orbit-viz-container");q=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),q.setPixelRatio(window.devicePixelRatio),q.setSize(e.clientWidth,e.clientHeight),B.innerHTML="",B.appendChild(q.domElement),U=new THREE.Scene,W=new THREE.PerspectiveCamera(50,e.clientWidth/e.clientHeight,.01,100),W.position.set(0,-4.2,3.2),W.lookAt(0,0,0);const t=new THREE.AmbientLight(4210752,1.2);U.add(t);const n=new THREE.DirectionalLight(16777215,1.1);n.position.set(5,-5,8),U.add(n);const o=new THREE.PointLight(4495871,.6,50);o.position.set(0,0,2),U.add(o);const a=new THREE.SphereGeometry($,64,64),i=document.createElement("canvas");i.width=i.height=1024;const s=i.getContext("2d"),r=s.createRadialGradient(512,512,100,512,512,512);r.addColorStop(0,"#00111f"),r.addColorStop(1,"#0b1a2b"),s.fillStyle=r,s.fillRect(0,0,1024,1024),s.strokeStyle="rgba(255,255,255,0.06)";for(let e=0;e<64;e++){const t=Math.floor(1024*(e+1)/65);s.beginPath(),s.moveTo(0,t),s.lineTo(1024,t),s.stroke()}const d=new THREE.CanvasTexture(i);d.wrapS=d.wrapT=THREE.RepeatWrapping;const l=new THREE.MeshPhongMaterial({map:d,transparent:!0,opacity:1,shininess:30,specular:2236962});O=new THREE.Mesh(a,l),O.castShadow=!0,O.receiveShadow=!0,U.add(O),te=h(6333946,1.1),O.add(te);const u=new THREE.SphereGeometry(.06,16,16),p=new THREE.MeshPhongMaterial({color:16729156,emissive:3342336,shininess:100,specular:5592405});N=new THREE.Mesh(u,p),N.castShadow=!0,U.add(N),_=h(16729156,.12),N.add(_);const b=new THREE.SphereGeometry(.06,16,16),M=new THREE.MeshPhongMaterial({color:4521796,emissive:13056,shininess:100,specular:5592405});j=new THREE.Mesh(b,M),j.castShadow=!0,U.add(j),ee=h(4521796,.12),j.add(ee),ne=g(3900150,.04),oe=g(11032055,.04),U.add(ne,oe),ae=E("Periapsis","#bfdbfe",48),ie=E("Apoapsis","#e9d5ff",48),U.add(ae,ie),y(),J=c(),Q=c(),Y=c();const f=new THREE.LineBasicMaterial({color:16729156,transparent:!0,opacity:.8,linewidth:2}),w=new THREE.LineBasicMaterial({color:4521796,transparent:!0,opacity:.8,linewidth:2}),v=new THREE.LineDashedMaterial({color:16777215,transparent:!0,opacity:.5,dashSize:.05,gapSize:.03,linewidth:1});X=new THREE.Line(J,f),U.add(X),Z=new THREE.Line(Q,w),U.add(Z),K=new THREE.Line(Y,v),K.computeLineDistances(),U.add(K),G=new OrbitControls(W,q.domElement),G.enableDamping=!0,G.dampingFactor=.05,G.enablePan=!0,G.enableZoom=!0,G.minDistance=1.5,G.maxDistance=15,G.autoRotate=!1;new ResizeObserver(()=>{W.aspect=e.clientWidth/e.clientHeight,W.updateProjectionMatrix(),q.setSize(e.clientWidth,e.clientHeight)}).observe(e),se=m(2278750,.12),re=m(2278750,.12),se.visible=!1,re.visible=!1,U.add(se,re),x()}function H(){if(!ce.playing)return;const e=ce.dt*ce.timeScale;de+=e,me=a(me,e),pe=a(pe,e);const t=n(me),o=n(pe);N.position.copy(t.position),j.position.copy(o.position),d(J,t.position),d(Q,o.position),l(),y(),p()}function P(){document.hidden?requestAnimationFrame(P):(requestAnimationFrame(P),H(),G.update(),q.render(U,W))}function k(){const e=document.getElementById("orbit-play-pause");e&&e.addEventListener("click",()=>{ce.playing=!ce.playing,e.textContent=ce.playing?"Pause":"Play"});const t=document.getElementById("orbit-reset");t&&t.addEventListener("click",x);const n=document.getElementById("burn-magnitude");n&&n.addEventListener("input",e=>{ce.burnMagnitude=parseFloat(e.target.value),document.getElementById("burn-magnitude-value").textContent=ce.burnMagnitude.toFixed(2)});const o=document.getElementById("time-scale");o&&o.addEventListener("input",e=>{ce.timeScale=parseFloat(e.target.value),document.getElementById("time-scale-value").textContent=`${ce.timeScale.toFixed(1)}\xd7`});const a=document.getElementById("real-world-units");a&&a.addEventListener("change",e=>{ce.realWorldUnits=!!e.target.checked,l()});const i={"scenario-basic":"basic","scenario-hohmann":"hohmann","scenario-rendezvous":"rendezvous"};Object.entries(i).forEach(([e,t])=>{const n=document.getElementById(e);n&&n.addEventListener("click",()=>{R(t),history.replaceState(null,"",`${location.pathname}#${t}`)})});[["burn-prograde","prograde"],["burn-retrograde","retrograde"],["burn-radial-out","radial-out"],["burn-radial-in","radial-in"]].forEach(([e,t])=>{const n=document.getElementById(e);n&&n.addEventListener("click",()=>T(t))}),document.addEventListener("keydown",n=>{if(!n.target||"INPUT"!==n.target.tagName&&"TEXTAREA"!==n.target.tagName)switch(n.key.toLowerCase()){case" ":n.preventDefault(),e?.click();break;case"[":if(n.preventDefault(),o){const e=Math.max(.1,ce.timeScale-.1);o.value=e,o.dispatchEvent(new Event("input"))}break;case"]":if(n.preventDefault(),o){const e=Math.min(10,ce.timeScale+.1);o.value=e,o.dispatchEvent(new Event("input"))}break;case"z":n.preventDefault(),T("prograde");break;case"x":n.preventDefault(),T("retrograde");break;case"c":n.preventDefault(),T("radial-out");break;case"v":n.preventDefault(),T("radial-in");break;case"r":n.preventDefault(),t?.click();break;case"?":case"h":n.preventDefault(),S()}}),document.body.insertAdjacentHTML("beforeend",'\n      <div id="keyboard-help" class="keyboard-shortcuts" aria-live="polite">\n        <h5>Keyboard Shortcuts</h5>\n        <div><kbd>Space</kbd>Play/Pause</div>\n        <div><kbd>[</kbd><kbd>]</kbd>Time Scale</div>\n        <div><kbd>Z</kbd>+V (Prograde)</div>\n        <div><kbd>X</kbd>-V (Retrograde)</div>\n        <div><kbd>C</kbd>+R (Radial Out)</div>\n        <div><kbd>V</kbd>-R (Radial In)</div>\n        <div><kbd>R</kbd>Reset</div>\n        <div><kbd>?</kbd>Toggle Help</div>\n      </div>')}function S(){const e=document.getElementById("keyboard-help");e&&(ge=!ge,e.classList.toggle("show",ge))}const B=e.getElementById("orbit-viz");if(!B)return;const F=document.createElement("canvas");if(!(F.getContext("webgl")||F.getContext("experimental-webgl")))return void(B.innerHTML='<div class="no-webgl">WebGL is not supported in your browser</div>');B.innerHTML='<div class="loading">Loading Orbital Simulator</div>';const $=1,L=1,A=6371,D=Math.sqrt(A*A*A/398600.4418),z=A/D,V=window.matchMedia("(prefers-reduced-motion: reduce)").matches;let U,W,q,G,O,N,j,X,Z,K,J,Q,Y,_,ee,te,ne,oe,ae,ie,se,re,ce={playing:!0,timeScale:1,burnMagnitude:.03,dt:.01,realWorldUnits:!1},de=0,le=0,ue=null,me=[1,0,0,0],pe=[1,0,0,Math.PI/6],he={result:null,lastAt:-1/0,interval:.3},ge=!1;const Ee=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){Ee.disconnect(),C(),k(),P();const e=location.hash.replace("#","");e&&R(e)}})},{threshold:.1});Ee.observe(document.getElementById("orbit-viz-container"))}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>initOrbitSimulator(document)):initOrbitSimulator(document);